<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cherry Muse</title>
  <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon.png">
  <link rel="stylesheet" href="../node_modules/cherry-muse/dist/cherry-markdown.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      height: 100vh;
      overflow: hidden;
      background: #fafafa;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    #editor-container {
      width: 100%;
      height: 100vh;
    }

    /* 滚动条样式 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #d0d0d0;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #b0b0b0;
    }
  </style>
</head>
<body>
  <div id="editor-container"></div>

  <script src="../node_modules/cherry-muse/dist/cherry-markdown.min.js"></script>
  <script>
    // 处理图片上传
    async function handleFileUpload(file, callback) {
      try {
        // 读取文件为 ArrayBuffer
        const arrayBuffer = await file.arrayBuffer();
        const buffer = new Uint8Array(arrayBuffer);
        
        // 获取文件扩展名
        const extension = file.name.split('.').pop() || 'png';
        
        // 调用主进程保存图片
        const relativePath = await window.electronAPI.saveImage(buffer, extension);
        
        if (relativePath) {
          // 返回 markdown 图片语法
          callback(relativePath);
        }
      } catch (error) {
        console.error('上传图片失败:', error);
      }
    }

    // 记录原始内容用于比较
    let originalContent = '';

    // 当前编辑模式
    let currentMode = 'edit&preview';
    const modes = ['edit&preview', 'editOnly', 'previewOnly'];
    let modeIndex = 0;

    // 打开文件的统一处理函数
    function openFileWithContent(content) {
      originalContent = content;
      cherry.setMarkdown(content);
      // 外部打开文件时，默认使用预览模式
      cherry.switchModel('previewOnly');
      modeIndex = modes.indexOf('previewOnly');
    }

    let setting  = Cherry.createMenuHook('设置', {
        iconName: 'settings',
        onClick: () => {
            alert("TODO")
        }
    });
    // Typora 风格配置
    const cherry = new Cherry({
      id: 'editor-container',
      value: '',
      toolbars: {
          customMenu: {
              setting: setting
          },
          toolbar: [
              'togglePreview',
              'switchModel',
              {
                  strikethrough: ['strikethrough', 'underline', 'sub', 'sup', 'ruby', 'bold', 'italic', 'quote'],
              },

              'size',
              '|',
              'color',
              'emoji',
              'header',
              '|',
              'badge',
              'panel',
              {
                  insert: [
                      'ol',
                      'ul',
                      'checklist',
                      'image',
                      'audio',
                      'video',
                      'file',
                      'link',
                      'hr',
                      'br',
                      'code',
                      'formula',
                      'toc',
                      'table',
                      'detail',
                      'lineTable',
                      'barTable',
                      'iframe',
                  ],
              },
              'graph',
              'echarts',
              'card',

              'redo',
              'undo',
          ],
          toolbarRight: ['setting','export'],
          bubble: ['bold', 'italic', 'header', 'underline', 'strikethrough', 'sub', 'sup', 'quote', 'link'], // array or false
      },
      editor: {
        defaultModel: 'edit&preview', // 默认分屏模式
      },
      fileUpload: handleFileUpload
    });

    // 监听 CodeMirror 的内容变化
    cherry.editor.editor.on('change', () => {
      const currentContent = cherry.getMarkdown();
      const isEdited = currentContent !== originalContent;
      window.electronAPI.setDocumentEdited(isEdited);
    });

    // 监听文件打开（命令行参数）
    window.electronAPI.onFileOpened((event, result) => {
      if (result) {
        openFileWithContent(result.content);
      }
    });

    // 监听保存事件（关闭窗口时触发）
    window.electronAPI.onMenuSave(async () => {
      const content = cherry.getMarkdown();
      const saved = await window.electronAPI.saveFile(content);
      if (saved) {
        originalContent = content;
      }
    });

    // 拖拽文件打开
    const editorContainer = document.getElementById('editor-container');
    editorContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
    });
    
    editorContainer.addEventListener('drop', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const files = Array.from(e.dataTransfer.files);
      const mdFile = files.find(f => f.name.endsWith('.md') || f.name.endsWith('.markdown'));
      
      if (mdFile) {
        const content = await mdFile.text();
        openFileWithContent(content);
        // 通过 IPC 保存文件路径（用于后续图片处理）
        await window.electronAPI.setFilePath(mdFile);
      }
    });

    // 快捷键
    document.addEventListener('keydown', async (e) => {
      // Cmd/Ctrl + S
      if ((e.metaKey || e.ctrlKey) && e.key === 's' && !e.shiftKey) {
        e.preventDefault();
        const content = cherry.getMarkdown();
        const saved = await window.electronAPI.saveFile(content);
        if (saved) {
          originalContent = content;
        }
      }
      // Cmd/Ctrl + Shift + S
      else if ((e.metaKey || e.ctrlKey) && e.key === 's' && e.shiftKey) {
        e.preventDefault();
        const content = cherry.getMarkdown();
        const saved = await window.electronAPI.saveFileAs(content);
        if (saved) {
          originalContent = content;
        }
      }
      // Cmd/Ctrl + O
      else if ((e.metaKey || e.ctrlKey) && e.key === 'o') {
        e.preventDefault();
        const result = await window.electronAPI.openFile();
        if (result) {
          openFileWithContent(result.content);
        }
      }
      // Cmd/Ctrl + /
      else if ((e.metaKey || e.ctrlKey) && e.key === '/') {
        e.preventDefault();
        modeIndex = (modeIndex + 1) % modes.length;
        currentMode = modes[modeIndex];
        cherry.switchModel(currentMode);
      }
    });
  </script>
</body>
</html>
